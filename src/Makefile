# =============================================================
# MAKEFILE PRINCIPAL â€“ TUTORIAL BÃSICO PARA INICIANTES
# =============================================================
#
# ğŸ“˜ O que Ã© um Makefile?
# -----------------------
# Ã‰ um arquivo de automaÃ§Ã£o que descreve como compilar e montar
# programas em C (ou outras linguagens). Ele evita que vocÃª tenha
# que digitar comandos longos no terminal toda vez.
#
# Em vez de usar:
#     gcc -Wall -std=c99 -o meu_programa main.c util.c
#
# VocÃª pode simplesmente escrever:
#     make meu_programa
#
# ğŸ“Œ Como funciona o Make?
# ------------------------
# O `make` usa regras com esta estrutura:
#
# alvo: dependÃªncias
# <tab> comando para gerar o alvo
#
# Exemplo:
#   main.o: main.c
#       gcc -c main.c -o main.o
#
# Esse comando diz:
# "Para gerar main.o, use o arquivo main.c com esse comando".
#
# ğŸ§© VariÃ¡veis AutomÃ¡ticas
# ------------------------
# $@ â†’ representa o nome do alvo (target)
# $< â†’ representa a primeira dependÃªncia
# $^ â†’ representa todas as dependÃªncias
#
# Exemplo:
#   meu_programa: main.c
#       gcc $< -o $@
#
# Ã‰ o mesmo que:
#   gcc main.c -o meu_programa
#
# âœ… Vantagens do Make
# ---------------------
# - Automatiza a compilaÃ§Ã£o
# - Evita recompilar o que nÃ£o mudou
# - Organiza melhor projetos grandes
# - Permite reutilizar regras e variÃ¡veis
#
# -------------------------------------------------------------
# VARIÃVEIS GLOBAIS DO PROJETO
# -------------------------------------------------------------



# estÃ£o definidas em um arquivo Ã  parte sÃ³ de configuraÃ§Ãµes
include common.mk



# -------------------------------------------------------------
# Limpeza em todos os subdiretÃ³rios com Makefile
# -------------------------------------------------------------

# Encontra todos os diretÃ³rios com um Makefile (exceto este prÃ³prio)
MAKE_DIRS := $(shell find . -mindepth 2 -name Makefile -exec dirname {} \;)

SUBDIRS := $(wildcard */)
MAKEFILES := $(foreach dir, $(SUBDIRS), $(wildcard $(dir)Makefile))



# -------------------------------------------------------------
# REGRAS DO MAKEFILE
# -------------------------------------------------------------

# Alvo padrÃ£o: compilar todos os programas da pasta s9
.PHONY: all  $(SUBDIRS) cleanbin clean

all: $(MAKE_DIRS)
	$(MAKE) -C $(MAKE_DIRS) all



.PHONY: clean cleanbin
clean:
	@echo "Limpando todos os subdiretÃ³rios com Makefile..."
	@for dir in $(MAKE_DIRS); do \
		echo "-> Limpando $$dir"; \
		$(MAKE) -C $$dir/ clean; \
	done

$(SUBDIRS):
	@echo "Building in $@"
	$(MAKE) -C $@/Makefile


cleanrepo: cleanbin
	@echo ">> Removing every '*.o' and '*.dSYM' ..."
	@find . -type d -name '*.dSYM' -exec rm -rf {}  \;
	@find . -type f -name '*.o' -exec rm -f {}  \;


cleanbin:
	@echo ">> Creating dummy C program..."
	@echo 'int main() { return 0; }' > .dummy.c

	@echo ">> Compiling dummy binary..."
	@$(CC) .dummy.c -o .dummy_binary

	@echo ">> Detecting binary type..."
	@TYPE=$$(file -b .dummy_binary | cut -d',' -f1); \
	echo ">> Detected binary type: $$TYPE"; \
	echo ">> Searching and removing matching files..."; \
	find . -type f ! -name ".dummy_binary" ! -name "Makefile" -exec sh -c 'file -b "$$0" | grep -q "^'"$$TYPE"'" && echo "Removing $$0" && rm -f "$$0"' {} \;

	@echo ">> Cleaning up dummy files..."
	@rm -f .dummy.c .dummy_binary
